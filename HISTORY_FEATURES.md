# 任务历史记录功能说明

## 概述

本次更新为任务管理系统添加了完整的历史记录功能，实现了以下核心特性：

1. **字段历史记录**：每个任务字段（如notes、text、due_date等）都保存完整的历史记录
2. **逻辑删除**：已完成的任务只是从界面隐藏，不从数据文件中物理删除
3. **不可逆修改**：UI界面的改动不会直接修改历史数据，而是追加新的历史记录
4. **历史查看器**：提供专门的历史记录查看界面

## 新功能详解

### 1. 历史记录结构

每个任务字段现在都有对应的历史记录，格式如下：

```json
{
  "text_history": [
    {
      "value": "任务内容",
      "timestamp": "2025-07-11T14:32:16.343541",
      "action": "create"
    },
    {
      "value": "更新后的任务内容",
      "timestamp": "2025-07-11T15:45:22.123456",
      "action": "update"
    }
  ]
}
```

### 2. 数据存储策略

- **新任务**：创建时自动为每个字段生成初始历史记录
- **字段更新**：每次修改字段值时，自动追加新的历史记录
- **任务完成**：标记为完成时记录完成时间，但保留在数据文件中
- **任务删除**：标记为逻辑删除（deleted=true），不从文件物理删除

### 3. 界面显示逻辑

- **加载时**：只显示每个字段的最新值（历史记录中的最后一条）
- **已完成任务**：只显示当天完成的任务，其他已完成任务自动隐藏
- **历史查看**：通过右键菜单的"历史记录"按钮查看完整历史

### 4. 历史记录查看器

#### 功能特性：
- 显示任务的基本信息
- 为每个字段显示独立的历史记录表格
- 包含时间、操作类型、字段值三列信息
- 支持滚动查看长历史记录
- 美观的表格样式和界面设计

#### 使用方法：
1. 右键点击任意任务标签
2. 在弹出的菜单中选择"历史记录"
3. 查看该任务所有字段的完整历史

### 5. 数据迁移

#### 自动迁移：
- 首次启动时自动检测旧格式数据
- 自动创建备份文件（tasks_backup.json）
- 将现有数据转换为新格式
- 保持所有原有数据不丢失

#### 手动迁移：
```bash
python migrate_data.py
```

## 技术实现

### 核心文件修改：

1. **config_manager.py**
   - 新增 `save_tasks()` 函数：支持历史记录保存
   - 新增 `load_tasks_with_history()` 函数：支持历史记录加载
   - 实现逻辑删除和字段历史记录管理

2. **quadrant_widget.py**
   - 修改 `load_tasks()` 方法：使用新的历史记录加载函数
   - 修改 `delete_task()` 方法：实现逻辑删除

3. **task_label.py**
   - 新增 `show_history()` 方法：显示历史记录查看器
   - 修改 `get_data()` 方法：包含完成日期信息
   - 在右键菜单中添加"历史记录"按钮

4. **history_viewer.py**（新增）
   - 完整的历史记录查看器实现
   - 支持多字段历史记录显示
   - 美观的表格界面设计

5. **migrate_data.py**（新增）
   - 数据迁移工具
   - 自动备份和格式转换
   - 迁移验证功能

### 数据格式变化：

#### 旧格式：
```json
{
  "id": "task_1",
  "text": "任务内容",
  "notes": "备注",
  "completed": false
}
```

#### 新格式：
```json
{
  "id": "task_1",
  "completed": false,
  "deleted": false,
  "created_at": "2025-07-11T14:32:16.343541",
  "updated_at": "2025-07-11T14:32:16.343541",
  "text_history": [
    {
      "value": "任务内容",
      "timestamp": "2025-07-11T14:32:16.343541",
      "action": "create"
    }
  ],
  "notes_history": [
    {
      "value": "备注",
      "timestamp": "2025-07-11T14:32:16.343541",
      "action": "create"
    }
  ]
}
```

## 使用指南

### 查看历史记录：
1. 右键点击任务标签
2. 选择"历史记录"
3. 在弹出的窗口中查看各字段的历史变化

### 任务管理：
- **编辑任务**：双击任务或右键选择"编辑"
- **完成任务**：勾选复选框，任务会隐藏但保留历史
- **删除任务**：右键选择"删除"，任务标记为逻辑删除

### 数据安全：
- 所有操作都会自动保存
- 历史记录不可逆修改
- 自动备份机制保护数据安全

## 注意事项

1. **数据兼容性**：新版本会自动迁移旧数据，无需手动操作
2. **性能影响**：历史记录会增加文件大小，但不会显著影响性能
3. **备份建议**：建议定期备份tasks.json文件
4. **历史清理**：如需清理历史记录，可以手动编辑tasks.json文件

## 未来扩展

1. **历史记录搜索**：支持按时间、内容搜索历史记录
2. **历史记录导出**：支持导出特定任务的历史记录
3. **历史记录统计**：提供任务修改频率等统计信息
4. **历史记录清理**：提供自动清理旧历史记录的功能 