<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>我的甘特图</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- frappe-gantt 样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.css">
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
            padding: 5px;
        }

        #gantt {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            min-height: 410px;
        }

        .task-name {
            font-weight: 600;
        }

        button {
            background-color: #f4f4f4;
            color: #333;
            border: 0px solid #ddd;
            border-radius: 6px;
            padding: 2px 8px;
            margin-right: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            background-color: #e5e5e5;
            border-color: #ccc;
        }

        button:active {
            background-color: #dcdcdc;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ddd;
            -webkit-transition: 0.2s;
            transition: 0.2s;
            border: 1px solid #37352f;
            scale: 0.75;
        }

        .slider:before {
            position: absolute;
            content: '';
            height: 12px;
            width: 12px;
            left: 4px;
            bottom: 3px;
            background-color: white;
            -webkit-transition: 0.2s;
            transition: 0.2s;
        }

        .slider.round {
            border-radius: 25px;
        }

        .slider.round:before {
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <div style="margin-bottom: 10px;">
        <button id="day">日</button>
        <button id="week">周</button>
        <button id="month">月</button>
        <button id="year">年</button>
    </div>
    <div id="gantt"></div>

    <!-- frappe-gantt 脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.js"></script>
    <script>
        window.addEventListener("error", function (event) {
            // 只拦截 clientWidth 报错
            if (event.message && event.message.includes("clientWidth")) {
                event.preventDefault();  // 阻止浏览器控制台打印红色错误
                return true;             // 告诉浏览器“这个错误已处理”
            }
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            // 等 DOM 渲染完再执行
            const resp = await fetch("/tasks");
            const tasks = await resp.json();

            // frappe-gantt 的任务对象支持更多字段，但基本这几个就可以
            // 如果你想自定义气泡内容，可以用 custom_popup_html
            const gantt = new Gantt("#gantt", tasks, {
                view_mode: "Week",
                auto_move_label: true,
                container_height: 480,
                bar_height: 20,
                holidays: { 'var(--g-weekend-highlight-color)': 'weekend' },
                infinite_padding: false,
                language: "zh-CN",
                readonly: true,
                date_format: "YYYY-MM-DD",
                popup: (ctx) => {
                    ctx.set_title(ctx.task.name);
                    let title = ctx.get_title();
                    if (ctx.task.description) ctx.set_subtitle(ctx.task.description);
                    else ctx.set_subtitle('');
                    ctx.set_details(`
                    <div style="
                        max-width: 320px;
                    ">
                        <div>Duration:${ctx.task.actual_duration} days</div>
                        <div>${ctx.task._start.toLocaleDateString('zh-CN')} - ${ctx.task._end.toLocaleDateString('zh-CN')}</div>
                        ${ctx.task.notes ? `<div style="
                                background:#f8f9fa;
                                padding:6px;
                                border-radius:6px;
                                border:1px solid #e5e7eb;
                            ">
                                <span style="white-space: pre-wrap; word-wrap: break-word;">${ctx.task.notes}</span>
                            </div>`
                            : ""
                        }
                    </div>
                    `);
                    let details = ctx.get_details();
                    details.style.lineHeight = '1.75';
                    details.style.margin = '10px 4px';
                    if (!ctx.chart.options.readonly) {
                        if (!ctx.chart.options.readonly_progress) {
                            ctx.add_action('Set Color', (task, chart) => {
                                const bar = chart.bars.find(
                                    ({ task: t }) => t.id === task.id,
                                ).$bar;
                                bar.style.fill = `hsla(${~~(360 * Math.random())}, 70%,  72%, 0.8)`;
                            });
                        }
                    }
                },
                on_click: (task) => console.log("click", task),
                on_date_change: (task, start, end) => console.log("date change", task, start, end),
                on_progress_change: (task, progress) => console.log("progress change", task, progress),
            });

            // 视图切换
            document.getElementById("day").onclick = () => gantt.change_view_mode("Day");
            document.getElementById("week").onclick = () => gantt.change_view_mode("Week");
            document.getElementById("month").onclick = () => gantt.change_view_mode("Month");
            document.getElementById("year").onclick = () => gantt.change_view_mode("Year");

        });
    </script>

</body>

</html>